{{- if .Values.cronJobs.retention.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "sendsign.fullname" . }}-retention
  labels:
    {{- include "sendsign.labels" . | nindent 4 }}
    app.kubernetes.io/component: retention-processor
spec:
  schedule: {{ .Values.cronJobs.retention.schedule | quote }}
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: {{ include "sendsign.serviceAccountName" . }}
          containers:
            - name: retention
              image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
              command: ["node", "dist/jobs/retention.js"]
              envFrom:
                - configMapRef:
                    name: {{ include "sendsign.fullname" . }}-config
                - secretRef:
                    name: {{ include "sendsign.fullname" . }}-secret
              resources:
                requests:
                  cpu: 100m
                  memory: 128Mi
                limits:
                  cpu: 500m
                  memory: 256Mi
          restartPolicy: OnFailure
---
{{- end }}
{{- if .Values.cronJobs.reminders.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "sendsign.fullname" . }}-reminders
  labels:
    {{- include "sendsign.labels" . | nindent 4 }}
    app.kubernetes.io/component: reminder-processor
spec:
  schedule: {{ .Values.cronJobs.reminders.schedule | quote }}
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: {{ include "sendsign.serviceAccountName" . }}
          containers:
            - name: reminders
              image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
              command: ["node", "dist/jobs/reminders.js"]
              envFrom:
                - configMapRef:
                    name: {{ include "sendsign.fullname" . }}-config
                - secretRef:
                    name: {{ include "sendsign.fullname" . }}-secret
              resources:
                requests:
                  cpu: 100m
                  memory: 128Mi
                limits:
                  cpu: 500m
                  memory: 256Mi
          restartPolicy: OnFailure
---
{{- end }}
{{- if .Values.cronJobs.expiry.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "sendsign.fullname" . }}-expiry
  labels:
    {{- include "sendsign.labels" . | nindent 4 }}
    app.kubernetes.io/component: expiry-processor
spec:
  schedule: {{ .Values.cronJobs.expiry.schedule | quote }}
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: {{ include "sendsign.serviceAccountName" . }}
          containers:
            - name: expiry
              image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
              command: ["node", "dist/jobs/expiry.js"]
              envFrom:
                - configMapRef:
                    name: {{ include "sendsign.fullname" . }}-config
                - secretRef:
                    name: {{ include "sendsign.fullname" . }}-secret
              resources:
                requests:
                  cpu: 100m
                  memory: 128Mi
                limits:
                  cpu: 500m
                  memory: 256Mi
          restartPolicy: OnFailure
{{- end }}
